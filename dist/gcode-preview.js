!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GCodePreview={},t.THREE)}(this,(function(t,e){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var r=n(e),o=i(e);class a extends class{constructor(t,e){this.gcode=t,this.comment=e}}{constructor(t,e,n){super(t,n),this.params=e}}class s{constructor(t,e){this.layer=t,this.commands=e}}class c{constructor(){this.layers=[],this.curZ=0,this.maxZ=0}parseCommand(t,e=!0){const n=t.trim().split(";"),i=n[0],r=e&&n[1]||null,o=i.split(/ +/g),s=o[0].toLowerCase();switch(s){case"g0":case"g1":const t=this.parseMove(o.slice(1));return new a(s,t,r);default:return null}}parseMove(t){return t.reduce(((t,e)=>{const n=e.charAt(0).toLowerCase();return"x"!=n&&"y"!=n&&"z"!=n&&"e"!=n&&"f"!=n||(t[n]=parseFloat(e.slice(1))),t}),{})}groupIntoLayers(t){for(const e of t.filter((t=>t instanceof a))){const t=e.params;t.z&&(this.curZ=t.z),t.e>0&&(null!=t.x||null!=t.y)&&this.curZ>this.maxZ?(this.maxZ=this.curZ,this.currentLayer=new s(this.layers.length,[e]),this.layers.push(this.currentLayer)):this.currentLayer&&this.currentLayer.commands.push(e)}return this.layers}parseGcode(t){const e=Array.isArray(t)?t:t.split("\n").filter((t=>t.length>0)),n=this.lines2commands(e);return this.groupIntoLayers(n),{layers:this.layers}}lines2commands(t){return t.filter((t=>t.length>0)).map((t=>this.parseCommand(t))).filter((t=>null!==t))}}const u={type:"change"},l={type:"start"},d={type:"end"};class h extends e.EventDispatcher{constructor(t,n){super(),void 0===n&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),n===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=t,this.domElement=n,this.enabled=!0,this.target=new e.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:e.MOUSE.ROTATE,MIDDLE:e.MOUSE.DOLLY,RIGHT:e.MOUSE.PAN},this.touches={ONE:e.TOUCH.ROTATE,TWO:e.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return s.phi},this.getAzimuthalAngle=function(){return s.theta},this.listenToKeyEvents=function(t){t.addEventListener("keydown",Y),this._domElementKeyEvents=t},this.saveState=function(){i.target0.copy(i.target),i.position0.copy(i.object.position),i.zoom0=i.object.zoom},this.reset=function(){i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=i.zoom0,i.object.updateProjectionMatrix(),i.dispatchEvent(u),i.update(),o=r.NONE},this.update=function(){const n=new e.Vector3,l=(new e.Quaternion).setFromUnitVectors(t.up,new e.Vector3(0,1,0)),d=l.clone().invert(),f=new e.Vector3,b=new e.Quaternion,y=2*Math.PI;return function(){const t=i.object.position;n.copy(t).sub(i.target),n.applyQuaternion(l),s.setFromVector3(n),i.autoRotate&&o===r.NONE&&A(2*Math.PI/60/60*i.autoRotateSpeed),i.enableDamping?(s.theta+=c.theta*i.dampingFactor,s.phi+=c.phi*i.dampingFactor):(s.theta+=c.theta,s.phi+=c.phi);let e=i.minAzimuthAngle,g=i.maxAzimuthAngle;return isFinite(e)&&isFinite(g)&&(e<-Math.PI?e+=y:e>Math.PI&&(e-=y),g<-Math.PI?g+=y:g>Math.PI&&(g-=y),s.theta=e<=g?Math.max(e,Math.min(g,s.theta)):s.theta>(e+g)/2?Math.max(e,s.theta):Math.min(g,s.theta)),s.phi=Math.max(i.minPolarAngle,Math.min(i.maxPolarAngle,s.phi)),s.makeSafe(),s.radius*=h,s.radius=Math.max(i.minDistance,Math.min(i.maxDistance,s.radius)),!0===i.enableDamping?i.target.addScaledVector(m,i.dampingFactor):i.target.add(m),n.setFromSpherical(s),n.applyQuaternion(d),t.copy(i.target).add(n),i.object.lookAt(i.target),!0===i.enableDamping?(c.theta*=1-i.dampingFactor,c.phi*=1-i.dampingFactor,m.multiplyScalar(1-i.dampingFactor)):(c.set(0,0,0),m.set(0,0,0)),h=1,!!(p||f.distanceToSquared(i.object.position)>a||8*(1-b.dot(i.object.quaternion))>a)&&(i.dispatchEvent(u),f.copy(i.object.position),b.copy(i.object.quaternion),p=!1,!0)}}(),this.dispose=function(){i.domElement.removeEventListener("contextmenu",X),i.domElement.removeEventListener("pointerdown",R),i.domElement.removeEventListener("wheel",F),i.domElement.removeEventListener("touchstart",G),i.domElement.removeEventListener("touchend",W),i.domElement.removeEventListener("touchmove",Z),i.domElement.ownerDocument.removeEventListener("pointermove",k),i.domElement.ownerDocument.removeEventListener("pointerup",H),null!==i._domElementKeyEvents&&i._domElementKeyEvents.removeEventListener("keydown",Y)};const i=this,r={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let o=r.NONE;const a=1e-6,s=new e.Spherical,c=new e.Spherical;let h=1;const m=new e.Vector3;let p=!1;const f=new e.Vector2,b=new e.Vector2,y=new e.Vector2,g=new e.Vector2,v=new e.Vector2,w=new e.Vector2,x=new e.Vector2,E=new e.Vector2,S=new e.Vector2;function L(){return Math.pow(.95,i.zoomSpeed)}function A(t){c.theta-=t}function O(t){c.phi-=t}const M=function(){const t=new e.Vector3;return function(e,n){t.setFromMatrixColumn(n,0),t.multiplyScalar(-e),m.add(t)}}(),P=function(){const t=new e.Vector3;return function(e,n){!0===i.screenSpacePanning?t.setFromMatrixColumn(n,1):(t.setFromMatrixColumn(n,0),t.crossVectors(i.object.up,t)),t.multiplyScalar(e),m.add(t)}}(),T=function(){const t=new e.Vector3;return function(e,n){const r=i.domElement;if(i.object.isPerspectiveCamera){const o=i.object.position;t.copy(o).sub(i.target);let a=t.length();a*=Math.tan(i.object.fov/2*Math.PI/180),M(2*e*a/r.clientHeight,i.object.matrix),P(2*n*a/r.clientHeight,i.object.matrix)}else i.object.isOrthographicCamera?(M(e*(i.object.right-i.object.left)/i.object.zoom/r.clientWidth,i.object.matrix),P(n*(i.object.top-i.object.bottom)/i.object.zoom/r.clientHeight,i.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),i.enablePan=!1)}}();function z(t){i.object.isPerspectiveCamera?h/=t:i.object.isOrthographicCamera?(i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom*t)),i.object.updateProjectionMatrix(),p=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),i.enableZoom=!1)}function C(t){i.object.isPerspectiveCamera?h*=t:i.object.isOrthographicCamera?(i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/t)),i.object.updateProjectionMatrix(),p=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),i.enableZoom=!1)}function j(t){f.set(t.clientX,t.clientY)}function B(t){g.set(t.clientX,t.clientY)}function _(t){if(1==t.touches.length)f.set(t.touches[0].pageX,t.touches[0].pageY);else{const e=.5*(t.touches[0].pageX+t.touches[1].pageX),n=.5*(t.touches[0].pageY+t.touches[1].pageY);f.set(e,n)}}function D(t){if(1==t.touches.length)g.set(t.touches[0].pageX,t.touches[0].pageY);else{const e=.5*(t.touches[0].pageX+t.touches[1].pageX),n=.5*(t.touches[0].pageY+t.touches[1].pageY);g.set(e,n)}}function N(t){const e=t.touches[0].pageX-t.touches[1].pageX,n=t.touches[0].pageY-t.touches[1].pageY,i=Math.sqrt(e*e+n*n);x.set(0,i)}function V(t){if(1==t.touches.length)b.set(t.touches[0].pageX,t.touches[0].pageY);else{const e=.5*(t.touches[0].pageX+t.touches[1].pageX),n=.5*(t.touches[0].pageY+t.touches[1].pageY);b.set(e,n)}y.subVectors(b,f).multiplyScalar(i.rotateSpeed);const e=i.domElement;A(2*Math.PI*y.x/e.clientHeight),O(2*Math.PI*y.y/e.clientHeight),f.copy(b)}function I(t){if(1==t.touches.length)v.set(t.touches[0].pageX,t.touches[0].pageY);else{const e=.5*(t.touches[0].pageX+t.touches[1].pageX),n=.5*(t.touches[0].pageY+t.touches[1].pageY);v.set(e,n)}w.subVectors(v,g).multiplyScalar(i.panSpeed),T(w.x,w.y),g.copy(v)}function U(t){const e=t.touches[0].pageX-t.touches[1].pageX,n=t.touches[0].pageY-t.touches[1].pageY,r=Math.sqrt(e*e+n*n);E.set(0,r),S.set(0,Math.pow(E.y/x.y,i.zoomSpeed)),z(S.y),x.copy(E)}function R(t){if(!1!==i.enabled)switch(t.pointerType){case"mouse":case"pen":!function(t){let n;switch(t.preventDefault(),i.domElement.focus?i.domElement.focus():window.focus(),t.button){case 0:n=i.mouseButtons.LEFT;break;case 1:n=i.mouseButtons.MIDDLE;break;case 2:n=i.mouseButtons.RIGHT;break;default:n=-1}switch(n){case e.MOUSE.DOLLY:if(!1===i.enableZoom)return;!function(t){x.set(t.clientX,t.clientY)}(t),o=r.DOLLY;break;case e.MOUSE.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===i.enablePan)return;B(t),o=r.PAN}else{if(!1===i.enableRotate)return;j(t),o=r.ROTATE}break;case e.MOUSE.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===i.enableRotate)return;j(t),o=r.ROTATE}else{if(!1===i.enablePan)return;B(t),o=r.PAN}break;default:o=r.NONE}o!==r.NONE&&(i.domElement.ownerDocument.addEventListener("pointermove",k),i.domElement.ownerDocument.addEventListener("pointerup",H),i.dispatchEvent(l))}(t)}}function k(t){if(!1!==i.enabled)switch(t.pointerType){case"mouse":case"pen":!function(t){if(!1===i.enabled)return;switch(t.preventDefault(),o){case r.ROTATE:if(!1===i.enableRotate)return;!function(t){b.set(t.clientX,t.clientY),y.subVectors(b,f).multiplyScalar(i.rotateSpeed);const e=i.domElement;A(2*Math.PI*y.x/e.clientHeight),O(2*Math.PI*y.y/e.clientHeight),f.copy(b),i.update()}(t);break;case r.DOLLY:if(!1===i.enableZoom)return;!function(t){E.set(t.clientX,t.clientY),S.subVectors(E,x),S.y>0?z(L()):S.y<0&&C(L()),x.copy(E),i.update()}(t);break;case r.PAN:if(!1===i.enablePan)return;!function(t){v.set(t.clientX,t.clientY),w.subVectors(v,g).multiplyScalar(i.panSpeed),T(w.x,w.y),g.copy(v),i.update()}(t)}}(t)}}function H(t){switch(t.pointerType){case"mouse":case"pen":!function(t){if(i.domElement.ownerDocument.removeEventListener("pointermove",k),i.domElement.ownerDocument.removeEventListener("pointerup",H),!1===i.enabled)return;i.dispatchEvent(d),o=r.NONE}()}}function F(t){!1===i.enabled||!1===i.enableZoom||o!==r.NONE&&o!==r.ROTATE||(t.preventDefault(),i.dispatchEvent(l),function(t){t.deltaY<0?C(L()):t.deltaY>0&&z(L()),i.update()}(t),i.dispatchEvent(d))}function Y(t){!1!==i.enabled&&!1!==i.enablePan&&function(t){let e=!1;switch(t.code){case i.keys.UP:T(0,i.keyPanSpeed),e=!0;break;case i.keys.BOTTOM:T(0,-i.keyPanSpeed),e=!0;break;case i.keys.LEFT:T(i.keyPanSpeed,0),e=!0;break;case i.keys.RIGHT:T(-i.keyPanSpeed,0),e=!0}e&&(t.preventDefault(),i.update())}(t)}function G(t){if(!1!==i.enabled){switch(t.preventDefault(),t.touches.length){case 1:switch(i.touches.ONE){case e.TOUCH.ROTATE:if(!1===i.enableRotate)return;_(t),o=r.TOUCH_ROTATE;break;case e.TOUCH.PAN:if(!1===i.enablePan)return;D(t),o=r.TOUCH_PAN;break;default:o=r.NONE}break;case 2:switch(i.touches.TWO){case e.TOUCH.DOLLY_PAN:if(!1===i.enableZoom&&!1===i.enablePan)return;!function(t){i.enableZoom&&N(t),i.enablePan&&D(t)}(t),o=r.TOUCH_DOLLY_PAN;break;case e.TOUCH.DOLLY_ROTATE:if(!1===i.enableZoom&&!1===i.enableRotate)return;!function(t){i.enableZoom&&N(t),i.enableRotate&&_(t)}(t),o=r.TOUCH_DOLLY_ROTATE;break;default:o=r.NONE}break;default:o=r.NONE}o!==r.NONE&&i.dispatchEvent(l)}}function Z(t){if(!1!==i.enabled)switch(t.preventDefault(),o){case r.TOUCH_ROTATE:if(!1===i.enableRotate)return;V(t),i.update();break;case r.TOUCH_PAN:if(!1===i.enablePan)return;I(t),i.update();break;case r.TOUCH_DOLLY_PAN:if(!1===i.enableZoom&&!1===i.enablePan)return;!function(t){i.enableZoom&&U(t),i.enablePan&&I(t)}(t),i.update();break;case r.TOUCH_DOLLY_ROTATE:if(!1===i.enableZoom&&!1===i.enableRotate)return;!function(t){i.enableZoom&&U(t),i.enableRotate&&V(t)}(t),i.update();break;default:o=r.NONE}}function W(t){!1!==i.enabled&&(i.dispatchEvent(d),o=r.NONE)}function X(t){!1!==i.enabled&&t.preventDefault()}i.domElement.addEventListener("contextmenu",X),i.domElement.addEventListener("pointerdown",R),i.domElement.addEventListener("wheel",F,{passive:!1}),i.domElement.addEventListener("touchstart",G,{passive:!1}),i.domElement.addEventListener("touchend",W),i.domElement.addEventListener("touchmove",Z,{passive:!1}),this.update()}}e.UniformsLib.line={linewidth:{value:1},resolution:{value:new e.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},e.ShaderLib.line={uniforms:e.UniformsUtils.merge([e.UniformsLib.common,e.UniformsLib.fog,e.UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t"};var m=function(t){e.ShaderMaterial.call(this,{type:"LineMaterial",uniforms:e.UniformsUtils.clone(e.ShaderLib.line.uniforms),vertexShader:e.ShaderLib.line.vertexShader,fragmentShader:e.ShaderLib.line.fragmentShader,clipping:!0}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)};(m.prototype=Object.create(e.ShaderMaterial.prototype)).constructor=m,m.prototype.isLineMaterial=!0;var p,f=function(){e.InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new e.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new e.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))};f.prototype=Object.assign(Object.create(e.InstancedBufferGeometry.prototype),{constructor:f,isLineSegmentsGeometry:!0,applyMatrix4:function(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(e.applyMatrix4(t),n.applyMatrix4(t),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(t){var n;t instanceof Float32Array?n=t:Array.isArray(t)&&(n=new Float32Array(t));var i=new e.InstancedInterleavedBuffer(n,6,1);return this.setAttribute("instanceStart",new e.InterleavedBufferAttribute(i,3,0)),this.setAttribute("instanceEnd",new e.InterleavedBufferAttribute(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(t){var n;t instanceof Float32Array?n=t:Array.isArray(t)&&(n=new Float32Array(t));var i=new e.InstancedInterleavedBuffer(n,6,1);return this.setAttribute("instanceColorStart",new e.InterleavedBufferAttribute(i,3,0)),this.setAttribute("instanceColorEnd",new e.InterleavedBufferAttribute(i,3,3)),this},fromWireframeGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromEdgesGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromMesh:function(t){return this.fromWireframeGeometry(new e.WireframeGeometry(t.geometry)),this},fromLineSegements:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},computeBoundingBox:function(){var t=new e.Box3;return function(){null===this.boundingBox&&(this.boundingBox=new e.Box3);var n=this.attributes.instanceStart,i=this.attributes.instanceEnd;void 0!==n&&void 0!==i&&(this.boundingBox.setFromBufferAttribute(n),t.setFromBufferAttribute(i),this.boundingBox.union(t))}}(),computeBoundingSphere:(p=new e.Vector3,function(){null===this.boundingSphere&&(this.boundingSphere=new e.Sphere),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(void 0!==t&&void 0!==n){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var r=0,o=0,a=t.count;o<a;o++)p.fromBufferAttribute(t,o),r=Math.max(r,i.distanceToSquared(p)),p.fromBufferAttribute(n,o),r=Math.max(r,i.distanceToSquared(p));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}),toJSON:function(){},applyMatrix:function(t){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(t)}});var b=function(){f.call(this),this.type="LineGeometry"};b.prototype=Object.assign(Object.create(f.prototype),{constructor:b,isLineGeometry:!0,setPositions:function(t){for(var e=t.length-3,n=new Float32Array(2*e),i=0;i<e;i+=3)n[2*i]=t[i],n[2*i+1]=t[i+1],n[2*i+2]=t[i+2],n[2*i+3]=t[i+3],n[2*i+4]=t[i+4],n[2*i+5]=t[i+5];return f.prototype.setPositions.call(this,n),this},setColors:function(t){for(var e=t.length-3,n=new Float32Array(2*e),i=0;i<e;i+=3)n[2*i]=t[i],n[2*i+1]=t[i+1],n[2*i+2]=t[i+2],n[2*i+3]=t[i+3],n[2*i+4]=t[i+4],n[2*i+5]=t[i+5];return f.prototype.setColors.call(this,n),this},fromLine:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},copy:function(){return this}});var y,g,v=function(t,n){e.Mesh.call(this),this.type="LineSegments2",this.geometry=void 0!==t?t:new f,this.material=void 0!==n?n:new m({color:16777215*Math.random()})};v.prototype=Object.assign(Object.create(e.Mesh.prototype),{constructor:v,isLineSegments2:!0,computeLineDistances:(y=new e.Vector3,g=new e.Vector3,function(){for(var t=this.geometry,n=t.attributes.instanceStart,i=t.attributes.instanceEnd,r=new Float32Array(2*n.data.count),o=0,a=0,s=n.data.count;o<s;o++,a+=2)y.fromBufferAttribute(n,o),g.fromBufferAttribute(i,o),r[a]=0===a?0:r[a-1],r[a+1]=r[a]+y.distanceTo(g);var c=new e.InstancedInterleavedBuffer(r,2,1);return t.setAttribute("instanceDistanceStart",new e.InterleavedBufferAttribute(c,1,0)),t.setAttribute("instanceDistanceEnd",new e.InterleavedBufferAttribute(c,1,1)),this}),raycast:function(){var t=new e.Vector4,n=new e.Vector4,i=new e.Vector4,r=new e.Vector3,o=new e.Matrix4,a=new e.Line3,s=new e.Vector3;return function(c,u){null===c.camera&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');var l=c.ray,d=c.camera,h=d.projectionMatrix,m=this.geometry,p=this.material,f=p.resolution,b=p.linewidth,y=m.attributes.instanceStart,g=m.attributes.instanceEnd;l.at(1,i),i.w=1,i.applyMatrix4(d.matrixWorldInverse),i.applyMatrix4(h),i.multiplyScalar(1/i.w),i.x*=f.x/2,i.y*=f.y/2,i.z=0,r.copy(i);var v=this.matrixWorld;o.multiplyMatrices(d.matrixWorldInverse,v);for(var w=0,x=y.count;w<x;w++){t.fromBufferAttribute(y,w),n.fromBufferAttribute(g,w),t.w=1,n.w=1,t.applyMatrix4(o),n.applyMatrix4(o),t.applyMatrix4(h),n.applyMatrix4(h),t.multiplyScalar(1/t.w),n.multiplyScalar(1/n.w);var E=t.z<-1&&n.z<-1,S=t.z>1&&n.z>1;if(!E&&!S){t.x*=f.x/2,t.y*=f.y/2,n.x*=f.x/2,n.y*=f.y/2,a.start.copy(t),a.start.z=0,a.end.copy(n),a.end.z=0;var L=a.closestPointToPointParameter(r,!0);a.at(L,s);var A=e.MathUtils.lerp(t.z,n.z,L),O=A>=-1&&A<=1,M=r.distanceTo(s)<.5*b;if(O&&M){a.start.fromBufferAttribute(y,w),a.end.fromBufferAttribute(g,w),a.start.applyMatrix4(v),a.end.applyMatrix4(v);var P=new e.Vector3,T=new e.Vector3;l.distanceSqToSegment(a.start,a.end,T,P),u.push({point:T,pointOnLine:P,distance:l.origin.distanceTo(T),object:this,face:null,faceIndex:w,uv:null,uv2:null})}}}}}()});class w extends e.LineSegments{constructor(t,n,i,r,o=4473924,a=8947848){o=new e.Color(o),a=new e.Color(a);var s=Math.round(t/n);i=Math.round(i/r)*r/2;const c=[],u=[];let l=0;for(var d=-1*(t=s*n/2);d<=t;d+=n){c.push(d,0,-1*i,d,0,i),(h=0===d?o:a).toArray(u,l),l+=3,h.toArray(u,l),l+=3,h.toArray(u,l),l+=3,h.toArray(u,l),l+=3}for(d=-1*i;d<=i;d+=r){var h;c.push(-1*t,0,d,t,0,d),(h=0===d?o:a).toArray(u,l),l+=3,h.toArray(u,l),l+=3,h.toArray(u,l),l+=3,h.toArray(u,l),l+=3}const m=new e.BufferGeometry;m.setAttribute("position",new e.Float32BufferAttribute(c,3)),m.setAttribute("color",new e.Float32BufferAttribute(u,3));super(m,new e.LineBasicMaterial({vertexColors:!0,toneMapped:!1})),this.type="BuildVolume"}}function x(t,e,n,i){const o=function(t,e,n,i){t*=.5,e*=.5,n*=.5;const o=new r.default.BufferGeometry,a=[];return a.push(-t,-e,-n,-t,e,-n,-t,e,-n,t,e,-n,t,e,-n,t,-e,-n,t,-e,-n,-t,-e,-n,-t,-e,n,-t,e,n,-t,e,n,t,e,n,t,e,n,t,-e,n,t,-e,n,-t,-e,n,-t,-e,-n,-t,-e,n,-t,e,-n,-t,e,n,t,e,-n,t,e,n,t,-e,-n,t,-e,n),o.setAttribute("position",new r.default.Float32BufferAttribute(a,3)),o}(t,e,n),a=new r.default.LineSegments(o,new r.default.LineDashedMaterial({color:new r.default.Color(i),dashSize:3,gapSize:1}));return a.computeLineDistances(),a}t.WebGLPreview=class{constructor(t){var e,n;if(this.parser=new c,this.backgroundColor=14737632,this.travelColor=10027008,this.extrusionColor=65280,this.renderExtrusion=!0,this.renderTravel=!1,this.singleLayerMode=!1,this.initialCameraPosition=[-100,400,450],this.debug=!1,this.scene=new o.Scene,this.scene.background=new o.Color(this.backgroundColor),this.canvas=t.canvas,this.targetId=t.targetId,this.endLayer=t.endLayer,this.startLayer=t.startLayer,this.topLayerColor=t.topLayerColor,this.lastSegmentColor=t.lastSegmentColor,this.lineWidth=t.lineWidth,this.buildVolume=t.buildVolume,this.initialCameraPosition=null!==(e=t.initialCameraPosition)&&void 0!==e?e:this.initialCameraPosition,this.debug=null!==(n=t.debug)&&void 0!==n?n:this.debug,console.debug("opts",t),!this.canvas&&!this.targetId)throw Error("Set either opts.canvas or opts.targetId");if(this.canvas)this.renderer=new o.WebGLRenderer({canvas:this.canvas,preserveDrawingBuffer:!0});else{const t=document.getElementById(this.targetId);if(!t)throw new Error("Unable to find element "+this.targetId);this.renderer=new o.WebGLRenderer({preserveDrawingBuffer:!0}),this.canvas=this.renderer.domElement,t.appendChild(this.canvas)}this.camera=new o.PerspectiveCamera(25,this.canvas.offsetWidth/this.canvas.offsetHeight,10,5e3),this.camera.position.fromArray(this.initialCameraPosition);const i=this.camera.far,r=.8*i;this.scene.fog=new o.Fog(this.scene.background,r,i),this.resize(),new h(this.camera,this.renderer.domElement),this.animate()}get layers(){return this.parser.layers}get maxLayerIndex(){var t;return(null!==(t=this.endLayer)&&void 0!==t?t:this.layers.length)-1}get minLayerIndex(){var t;return this.singleLayerMode?this.maxLayerIndex:(null!==(t=this.startLayer)&&void 0!==t?t:0)-1}animate(){requestAnimationFrame((()=>this.animate())),this.renderer.render(this.scene,this.camera)}processGCode(t){this.parser.parseGcode(t),this.render()}render(){for(var t,e;this.scene.children.length>0;)this.scene.remove(this.scene.children[0]);if(this.debug){const t=new o.AxesHelper(Math.max(this.buildVolume.x/2,this.buildVolume.y/2)+20);this.scene.add(t)}this.buildVolume&&this.drawBuildVolume(),this.group=new o.Group,this.group.name="gcode";const n={x:0,y:0,z:0,e:0};for(let i=0;i<this.layers.length&&!(i>this.maxLayerIndex);i++){const r={extrusion:[],travel:[],z:n.z},a=this.layers[i];for(const t of a.commands)if("g0"==t.gcode||"g1"==t.gcode){const e=t,o={x:void 0!==e.params.x?e.params.x:n.x,y:void 0!==e.params.y?e.params.y:n.y,z:void 0!==e.params.z?e.params.z:n.z,e:void 0!==e.params.e?e.params.e:n.e};if(i>=this.minLayerIndex){const t=e.params.e>0;(t&&this.renderExtrusion||!t&&this.renderTravel)&&this.addLineSegment(r,n,o,t)}e.params.x&&(n.x=e.params.x),e.params.y&&(n.y=e.params.y),e.params.z&&(n.z=e.params.z),e.params.e&&(n.e=e.params.e)}if(this.renderExtrusion){const n=Math.round(80*i/this.layers.length),a=new o.Color(`hsl(0, 0%, ${n}%)`).getHex();if(i==this.layers.length-1){const n=null!==(t=this.topLayerColor)&&void 0!==t?t:a,i=null!==(e=this.lastSegmentColor)&&void 0!==e?e:n,o=r.extrusion.splice(-3);this.addLine(r.extrusion,n);const s=r.extrusion.splice(-3);this.addLine([...s,...o],i)}else this.addLine(r.extrusion,a)}this.renderTravel&&this.addLine(r.travel,this.travelColor)}this.group.quaternion.setFromEuler(new o.Euler(-Math.PI/2,0,0)),this.buildVolume?this.group.position.set(-this.buildVolume.x/2,0,this.buildVolume.y/2):this.group.position.set(-100,0,100),this.scene.add(this.group),this.renderer.render(this.scene,this.camera)}drawBuildVolume(){this.scene.add(new w(this.buildVolume.x,10,this.buildVolume.y,10));const t=x(this.buildVolume.x,this.buildVolume.z,this.buildVolume.y,8947848);t.position.setY(this.buildVolume.z/2),this.scene.add(t)}clear(){this.startLayer=1,this.endLayer=1/0,this.singleLayerMode=!1,this.parser=new c}resize(){const[t,e]=[this.canvas.offsetWidth,this.canvas.offsetHeight];this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(t,e,!1)}addLineSegment(t,e,n,i){(i?t.extrusion:t.travel).push(e.x,e.y,e.z,n.x,n.y,n.z)}addLine(t,e){if("number"==typeof this.lineWidth&&this.lineWidth>0)return void this.addThickLine(t,e);const n=new o.BufferGeometry;n.setAttribute("position",new o.Float32BufferAttribute(t,3));const i=new o.LineBasicMaterial({color:e}),r=new o.LineSegments(n,i);this.group.add(r)}addThickLine(t,e){if(!t.length)return;const n=new b,i=new m({color:e,linewidth:this.lineWidth/(1e3*window.devicePixelRatio)});n.setPositions(t);const r=new v(n,i);this.group.add(r)}},Object.defineProperty(t,"__esModule",{value:!0})}));
